% Input: coefficient matrix C of size 4x27
% Output: solution matrix S of size 4x21

function S = red_40x61_p6pf_refract(C)

    M = sparse([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,5,5,5,5,5,5,6,6,6,6,6,6,7,7,7,7,7,7,8,8,8,8,8,8,9,9,9,9,9,9,10,10,10,10,10,10,11,11,11,11,11,11,12,12,12,12,12,12,13,13,13,13,13,13,14,14,14,14,14,14,15,15,15,15,15,15,16,16,16,16,16,16,17,17,17,17,17,17,18,18,18,18,18,18,19,19,19,19,19,19,20,20,20,20,20,20,21,21,21,21,21,21,22,22,22,22,22,22,23,23,23,23,23,23,24,24,24,24,24,24,25,25,25,25,25,25,26,26,26,26,26,26,27,27,27,27,27,27,28,28,28,28,28,28,29,29,29,29,29,29,30,30,30,30,30,30,31,31,31,31,31,31,32,32,32,32,32,32,33,33,33,33,33,33,34,34,34,34,34,34,35,35,35,35,35,35,36,36,36,36,36,36,37,37,37,37,37,37,38,38,38,38,38,38,39,39,39,39,39,39,40,40,40,40,40,40],[2,4,7,12,13,15,16,18,20,21,25,27,29,30,32,33,34,35,38,41,42,48,49,50,55,57,1,3,5,7,8,10,13,14,16,17,19,21,22,23,25,26,27,28,31,36,39,43,46,51,56,58,5,6,9,11,16,17,18,19,23,24,27,28,31,32,35,36,37,40,43,44,45,47,52,57,59,61,16,23,27,30,31,41,1,9,17,24,28,31,10,19,32,36,43,58,2,15,16,20,50,53,3,16,17,46,51,54,5,18,19,47,52,60,12,23,49,50,53,55,13,23,24,51,54,56,16,52,57,58,60,61,27,34,38,48,53,55,21,27,28,39,54,56,23,35,36,40,60,61,16,23,27,29,31,42,7,9,17,24,28,43,10,19,31,36,44,58,4,12,16,20,50,53,5,13,17,46,51,54,6,16,19,47,52,60,15,23,48,50,53,55,16,21,24,51,54,56,18,23,52,58,60,61,27,33,38,49,53,55,23,25,28,39,54,56,27,36,40,57,60,61,1,5,16,23,43,44,7,16,23,27,31,32,8,9,10,17,24,28,9,10,11,19,36,58,13,16,18,20,50,53,14,17,19,46,51,54,17,19,45,47,52,60,21,23,50,53,55,57,22,24,51,54,56,58,24,52,58,59,60,61,25,27,35,38,53,55,26,28,36,39,54,56,28,36,37,40,60,61],C([9,13,21,33,37,41,45,49,53,61,81,89,17,25,29,77,85,93,105,1,5,57,65,73,101,69,1,9,13,17,21,29,33,37,41,45,49,57,61,65,77,81,85,89,25,93,105,5,53,73,101,69,9,13,21,29,33,37,41,45,57,61,77,81,17,25,85,89,93,105,1,5,49,53,73,65,69,101,98,102,106,86,90,58,58,90,98,102,106,86,90,98,86,106,58,102,58,86,90,98,102,106,58,86,90,98,102,106,58,86,90,98,102,106,58,90,86,98,102,106,58,86,90,98,102,106,58,98,86,90,102,106,90,86,106,58,98,102,58,86,90,106,98,102,58,86,90,106,98,102,99,103,107,79,91,67,79,91,99,103,107,67,91,99,79,107,67,103,67,79,91,99,103,107,67,79,91,99,103,107,67,79,91,99,103,107,67,91,79,99,103,107,67,79,91,99,103,107,67,79,99,91,103,107,91,79,107,67,99,103,67,79,91,107,99,103,79,91,107,67,99,103,84,100,104,108,92,96,84,100,104,108,92,96,84,92,96,100,104,108,84,92,96,100,108,104,84,92,96,100,104,108,84,92,96,100,104,108,84,92,96,100,104,108,84,92,100,104,108,96,84,92,100,104,108,96,84,100,92,96,104,108,84,92,96,108,100,104,84,92,96,108,100,104,84,92,96,108,100,104]),40,61);

    [L,~,P] = lu(M(:,1:28));
    P = P';
    M = [P*L P(:,29:end)]\M(:,29:end);
    M = M(end-11:end,:);

    T0 = zeros(21);
    T0([1,2,3,4,8,9,17,18,19,15,16,21],:) = -M(:,13:end);
    T0([383,216,238,262,284,411,307,329,440]) = 1;
    T1 = zeros(21);
    T1([1,2,3,4,8,9,17,18,19,15,16,21],[1,2,3,4,8,9,17,18,19,15,16,21]) = M(:,1:12);
    T1([89,111,133,199,221,243,265,287,419]) = 1;

    [V,~] = eig(T0,T1);
    S = V(17:20,:)./repmat(V(21,:),4,1);

    y = sqrt(S(3,:));
    wx = S([1,2],:)./y;
    z = S(4,:);
    S = [wx -wx; y -y; z z];
    S = S(:,all(isfinite(S)));

end