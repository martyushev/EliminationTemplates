import numpy as np
from scipy.sparse import csr_matrix
from scipy.linalg import lu, solve, eig

# Input: coefficient matrix C of size 4x20
# Output: solution matrix S of size 4x18

def red_42x60_p4p_fr(C):
    M = csr_matrix((C.flat[[6,8,10,11,13,14,15,17,18,19,6,8,10,11,13,14,15,17,18,19,6,8,10,11,13,14,15,18,19,17,6,8,10,11,13,14,15,18,19,17,6,8,10,11,13,14,15,17,18,19,6,8,10,11,14,15,18,19,13,17,6,8,11,14,15,18,19,10,13,17,6,8,10,11,13,14,15,17,18,19,6,11,14,15,18,19,8,10,13,17,6,8,10,11,15,14,18,19,13,17,6,11,14,15,18,19,8,10,13,17,6,8,10,11,13,14,15,17,18,19,6,11,14,15,18,19,8,10,13,17,6,11,14,15,18,19,8,10,13,17,20,21,22,23,24,25,26,27,28,29,30,31,32,34,35,36,38,39,33,37,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,20,21,22,23,24,25,26,27,31,32,34,35,36,38,39,28,29,30,33,37,20,21,22,23,24,25,26,27,28,30,31,32,35,34,36,38,39,29,33,37,20,21,22,23,26,28,24,25,27,29,30,31,32,33,34,35,36,37,38,39,20,21,23,25,26,27,31,32,34,35,36,38,39,22,24,28,29,30,33,37,20,23,26,25,27,31,32,34,35,36,38,39,21,22,24,28,29,30,33,37,40,41,42,43,44,45,46,47,48,49,50,51,52,54,55,56,58,59,53,57,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,40,41,42,43,44,45,46,47,51,52,54,55,56,58,59,48,49,50,53,57,40,41,42,43,44,45,46,47,48,50,51,52,55,54,56,58,59,49,53,57,40,41,42,43,46,48,44,45,47,49,50,51,52,53,54,55,56,57,58,59,40,41,43,45,46,47,51,52,54,55,56,58,59,42,44,48,49,50,53,57,40,43,46,45,47,51,52,54,55,56,58,59,41,42,44,48,49,50,53,57,66,68,70,71,73,74,75,77,78,79,66,68,70,71,73,74,75,77,78,79,66,68,70,71,73,74,75,78,79,77,66,68,70,71,73,74,75,78,79,77,66,68,70,71,73,74,75,77,78,79,66,68,70,71,74,75,78,79,73,77,66,68,71,74,75,78,79,70,73,77,66,68,70,71,73,74,75,77,78,79,66,71,74,75,78,79,68,70,73,77,66,68,70,71,75,74,78,79,73,77,66,71,74,75,78,79,68,70,73,77,66,68,70,71,73,74,75,77,78,79,66,71,74,75,78,79,68,70,73,77,66,71,74,75,78,79,68,70,73,77]],([0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,28,29,29,29,29,29,29,29,29,29,29,30,30,30,30,30,30,30,30,30,30,31,31,31,31,31,31,31,31,31,31,32,32,32,32,32,32,32,32,32,32,33,33,33,33,33,33,33,33,33,33,34,34,34,34,34,34,34,34,34,34,35,35,35,35,35,35,35,35,35,35,36,36,36,36,36,36,36,36,36,36,37,37,37,37,37,37,37,37,37,37,38,38,38,38,38,38,38,38,38,38,39,39,39,39,39,39,39,39,39,39,40,40,40,40,40,40,40,40,40,40,41,41,41,41,41,41,41,41,41,41],[0,1,2,4,5,7,15,17,20,29,1,2,3,5,6,8,17,42,45,52,4,5,6,7,8,9,20,22,32,45,10,11,12,15,17,20,25,29,34,48,11,12,13,17,42,45,48,49,52,56,14,16,18,19,21,28,31,35,44,51,15,17,20,22,29,32,36,42,45,52,16,18,43,44,46,47,51,53,54,58,19,21,23,31,33,37,44,46,47,54,24,26,27,28,30,31,35,38,51,55,25,29,32,34,36,39,48,49,52,56,26,27,50,51,53,54,55,57,58,59,28,31,33,35,37,40,51,53,54,58,30,35,37,38,40,41,55,57,58,59,0,1,2,4,5,7,14,15,16,17,18,19,20,21,28,29,31,35,44,51,1,2,3,5,6,8,16,17,18,42,43,44,45,46,47,51,52,53,54,58,4,5,6,7,8,9,19,20,21,22,23,31,32,33,37,44,45,46,47,54,10,11,12,15,17,20,24,25,26,27,28,29,30,31,34,35,38,48,51,55,11,12,13,17,26,27,42,45,48,49,50,51,52,53,54,55,56,57,58,59,15,17,20,22,28,29,31,32,33,35,36,37,40,42,45,51,52,53,54,58,25,29,30,32,34,35,36,37,38,39,40,41,48,49,52,55,56,57,58,59,0,1,2,4,5,7,14,15,16,17,18,19,20,21,28,29,31,35,44,51,1,2,3,5,6,8,16,17,18,42,43,44,45,46,47,51,52,53,54,58,4,5,6,7,8,9,19,20,21,22,23,31,32,33,37,44,45,46,47,54,10,11,12,15,17,20,24,25,26,27,28,29,30,31,34,35,38,48,51,55,11,12,13,17,26,27,42,45,48,49,50,51,52,53,54,55,56,57,58,59,15,17,20,22,28,29,31,32,33,35,36,37,40,42,45,51,52,53,54,58,25,29,30,32,34,35,36,37,38,39,40,41,48,49,52,55,56,57,58,59,0,1,2,4,5,7,15,17,20,29,1,2,3,5,6,8,17,42,45,52,4,5,6,7,8,9,20,22,32,45,10,11,12,15,17,20,25,29,34,48,11,12,13,17,42,45,48,49,52,56,14,16,18,19,21,28,31,35,44,51,15,17,20,22,29,32,36,42,45,52,16,18,43,44,46,47,51,53,54,58,19,21,23,31,33,37,44,46,47,54,24,26,27,28,30,31,35,38,51,55,25,29,32,34,36,39,48,49,52,56,26,27,50,51,53,54,55,57,58,59,28,31,33,35,37,40,51,53,54,58,30,35,37,38,40,41,55,57,58,59])),shape=(42,60))
    M = M.toarray()

    P,L,_ = lu(M[:,:31])
    M = solve(np.concatenate((P@L,P[:,31:]),axis=1),M[:,31:])
    M = M[-11:,:]

    T0 = np.zeros((18,18))
    T0[[2,3,5,6,9,10,12,13,14,16,17],:] = -M[:,11:]
    T0.flat[[10,29,84,140,159,214,287]] = 1
    T1 = np.zeros((18,18))
    T1[np.ix_([2,3,5,6,9,10,12,13,14,16,17],[2,3,5,6,9,10,12,13,14,16,17])] = M[:,:11]
    T1.flat[[0,19,76,133,152,209,285]] = 1

    _,V = eig(T0,T1)
    S = V[13:17,:]/np.tile(V[17,:],(4,1))
    S = S[:,np.all(np.isfinite(S),axis=0)]

    return S