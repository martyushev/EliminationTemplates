import numpy as np

def coefs_p4p_fr(data):
    M1 = data[0].T.flat
    M2 = data[1].T.flat
    M3 = data[2].T.flat

    C = np.zeros((4,20))
    C.flat[6] = M1[0]*M2[0]+M1[1]*M2[1]+M1[2]*M2[2]+M1[3]*M2[3]
    C.flat[26] = M1[0]*M3[0]+M1[1]*M3[1]+M1[2]*M3[2]+M1[3]*M3[3]
    C.flat[20] = M1[0]*M3[12]+M1[1]*M3[13]+M1[2]*M3[14]+M1[3]*M3[15]
    C.flat[14] = M1[4]*M2[4]+M1[5]*M2[5]+M1[6]*M2[6]+M1[7]*M2[7]
    C.flat[34] = M1[4]*M3[4]+M1[5]*M3[5]+M1[6]*M3[6]+M1[7]*M3[7]
    C.flat[25] = M1[4]*M3[16]+M1[5]*M3[17]+M1[6]*M3[18]+M1[7]*M3[19]
    C.flat[10] = M1[8]*M2[8]+M1[9]*M2[9]+M1[10]*M2[10]+M1[11]*M2[11]
    C.flat[30] = M1[8]*M3[8]+M1[9]*M3[9]+M1[10]*M3[10]+M1[11]*M3[11]
    C.flat[22] = M1[8]*M3[20]+M1[9]*M3[21]+M1[10]*M3[22]+M1[11]*M3[23]
    C.flat[36] = M1[12]*M3[24]+M1[13]*M3[25]+M1[14]*M3[26]+M1[15]*M3[27]
    C.flat[39] = M1[12]*M3[28]+M1[13]*M3[29]+M1[14]*M3[30]+M1[15]*M3[31]
    C.flat[19] = M1[14]*M2[14]+M1[15]*M2[15]+M1[12]*M2[12]+M1[13]*M2[13]
    C.flat[46] = M2[0]*M3[0]+M2[1]*M3[1]+M2[2]*M3[2]+M2[3]*M3[3]
    C.flat[40] = M2[0]*M3[12]+M2[1]*M3[13]+M2[2]*M3[14]+M2[3]*M3[15]
    C.flat[54] = M2[4]*M3[4]+M2[5]*M3[5]+M2[6]*M3[6]+M2[7]*M3[7]
    C.flat[45] = M2[4]*M3[16]+M2[5]*M3[17]+M2[6]*M3[18]+M2[7]*M3[19]
    C.flat[50] = M2[8]*M3[8]+M2[9]*M3[9]+M2[10]*M3[10]+M2[11]*M3[11]
    C.flat[42] = M2[8]*M3[20]+M2[9]*M3[21]+M2[10]*M3[22]+M2[11]*M3[23]
    C.flat[56] = M2[12]*M3[24]+M2[13]*M3[25]+M2[14]*M3[26]+M2[15]*M3[27]
    C.flat[59] = M2[15]*M3[31]+M2[12]*M3[28]+M2[13]*M3[29]+M2[14]*M3[30]
    C.flat[66] = M1[0]**2+M1[1]**2+M1[2]**2+M1[3]**2-M2[0]**2-M2[1]**2-M2[2]**2-M2[3]**2
    C.flat[74] = M1[4]**2+M1[5]**2+M1[6]**2+M1[7]**2-M2[4]**2-M2[5]**2-M2[6]**2-M2[7]**2
    C.flat[70] = M1[8]**2+M1[9]**2+M1[10]**2+M1[11]**2-M2[8]**2-M2[9]**2-M2[10]**2-M2[11]**2
    C.flat[79] = M1[12]**2+M1[13]**2+M1[14]**2+M1[15]**2-M2[12]**2-M2[13]**2-M2[14]**2-M2[15]**2
    C.flat[71] = 2*M1[0]*M1[4]+2*M1[1]*M1[5]+2*M1[2]*M1[6]+2*M1[3]*M1[7]-2*M2[0]*M2[4]-2*M2[1]*M2[5]-2*M2[2]*M2[6]-2*M2[3]*M2[7]
    C.flat[68] = 2*M1[0]*M1[8]+2*M1[1]*M1[9]+2*M1[2]*M1[10]+2*M1[3]*M1[11]-2*M2[0]*M2[8]-2*M2[1]*M2[9]-2*M2[2]*M2[10]-2*M2[3]*M2[11]
    C.flat[75] = 2*M1[0]*M1[12]+2*M1[1]*M1[13]+2*M1[2]*M1[14]+2*M1[3]*M1[15]-2*M2[0]*M2[12]-2*M2[1]*M2[13]-2*M2[2]*M2[14]-2*M2[3]*M2[15]
    C.flat[11] = M1[0]*M2[4]+M1[4]*M2[0]+M1[1]*M2[5]+M1[5]*M2[1]+M1[2]*M2[6]+M1[6]*M2[2]+M1[3]*M2[7]+M1[7]*M2[3]
    C.flat[8] = M1[0]*M2[8]+M1[8]*M2[0]+M1[1]*M2[9]+M1[9]*M2[1]+M1[2]*M2[10]+M1[10]*M2[2]+M1[3]*M2[11]+M1[11]*M2[3]
    C.flat[15] = M1[0]*M2[12]+M1[12]*M2[0]+M1[1]*M2[13]+M1[13]*M2[1]+M1[2]*M2[14]+M1[14]*M2[2]+M1[3]*M2[15]+M1[15]*M2[3]
    C.flat[31] = M1[0]*M3[4]+M1[4]*M3[0]+M1[1]*M3[5]+M1[5]*M3[1]+M1[2]*M3[6]+M1[6]*M3[2]+M1[3]*M3[7]+M1[7]*M3[3]
    C.flat[28] = M1[0]*M3[8]+M1[8]*M3[0]+M1[1]*M3[9]+M1[9]*M3[1]+M1[2]*M3[10]+M1[10]*M3[2]+M1[3]*M3[11]+M1[11]*M3[3]
    C.flat[23] = M1[0]*M3[16]+M1[4]*M3[12]+M1[1]*M3[17]+M1[5]*M3[13]+M1[2]*M3[18]+M1[6]*M3[14]+M1[3]*M3[19]+M1[7]*M3[15]
    C.flat[21] = M1[0]*M3[20]+M1[8]*M3[12]+M1[1]*M3[21]+M1[9]*M3[13]+M1[2]*M3[22]+M1[10]*M3[14]+M1[3]*M3[23]+M1[11]*M3[15]
    C.flat[27] = M1[0]*M3[24]+M1[12]*M3[12]+M1[1]*M3[25]+M1[13]*M3[13]+M1[2]*M3[26]+M1[14]*M3[14]+M1[3]*M3[27]+M1[15]*M3[15]
    C.flat[35] = M1[0]*M3[28]+M1[12]*M3[0]+M1[1]*M3[29]+M1[13]*M3[1]+M1[2]*M3[30]+M1[14]*M3[2]+M1[3]*M3[31]+M1[15]*M3[3]
    C.flat[73] = 2*M1[4]*M1[8]+2*M1[5]*M1[9]+2*M1[6]*M1[10]+2*M1[7]*M1[11]-2*M2[4]*M2[8]-2*M2[5]*M2[9]-2*M2[6]*M2[10]-2*M2[7]*M2[11]
    C.flat[78] = 2*M1[4]*M1[12]+2*M1[5]*M1[13]+2*M1[6]*M1[14]+2*M1[7]*M1[15]-2*M2[4]*M2[12]-2*M2[5]*M2[13]-2*M2[6]*M2[14]-2*M2[7]*M2[15]
    C.flat[13] = M1[4]*M2[8]+M1[8]*M2[4]+M1[5]*M2[9]+M1[9]*M2[5]+M1[6]*M2[10]+M1[10]*M2[6]+M1[7]*M2[11]+M1[11]*M2[7]
    C.flat[18] = M1[4]*M2[12]+M1[12]*M2[4]+M1[5]*M2[13]+M1[13]*M2[5]+M1[6]*M2[14]+M1[14]*M2[6]+M1[7]*M2[15]+M1[15]*M2[7]
    C.flat[33] = M1[4]*M3[8]+M1[8]*M3[4]+M1[5]*M3[9]+M1[9]*M3[5]+M1[6]*M3[10]+M1[10]*M3[6]+M1[7]*M3[11]+M1[11]*M3[7]
    C.flat[24] = M1[4]*M3[20]+M1[8]*M3[16]+M1[5]*M3[21]+M1[9]*M3[17]+M1[6]*M3[22]+M1[10]*M3[18]+M1[7]*M3[23]+M1[11]*M3[19]
    C.flat[32] = M1[4]*M3[24]+M1[12]*M3[16]+M1[5]*M3[25]+M1[13]*M3[17]+M1[6]*M3[26]+M1[14]*M3[18]+M1[7]*M3[27]+M1[15]*M3[19]
    C.flat[38] = M1[4]*M3[28]+M1[12]*M3[4]+M1[5]*M3[29]+M1[13]*M3[5]+M1[6]*M3[30]+M1[14]*M3[6]+M1[7]*M3[31]+M1[15]*M3[7]
    C.flat[77] = 2*M1[8]*M1[12]+2*M1[9]*M1[13]+2*M1[10]*M1[14]+2*M1[11]*M1[15]-2*M2[8]*M2[12]-2*M2[9]*M2[13]-2*M2[10]*M2[14]-2*M2[11]*M2[15]
    C.flat[17] = M1[8]*M2[12]+M1[12]*M2[8]+M1[9]*M2[13]+M1[13]*M2[9]+M1[10]*M2[14]+M1[14]*M2[10]+M1[11]*M2[15]+M1[15]*M2[11]
    C.flat[29] = M1[8]*M3[24]+M1[12]*M3[20]+M1[9]*M3[25]+M1[13]*M3[21]+M1[10]*M3[26]+M1[14]*M3[22]+M1[11]*M3[27]+M1[15]*M3[23]
    C.flat[37] = M1[8]*M3[28]+M1[12]*M3[8]+M1[9]*M3[29]+M1[13]*M3[9]+M1[10]*M3[30]+M1[14]*M3[10]+M1[11]*M3[31]+M1[15]*M3[11]
    C.flat[51] = M2[0]*M3[4]+M2[4]*M3[0]+M2[1]*M3[5]+M2[5]*M3[1]+M2[2]*M3[6]+M2[6]*M3[2]+M2[3]*M3[7]+M2[7]*M3[3]
    C.flat[48] = M2[0]*M3[8]+M2[8]*M3[0]+M2[1]*M3[9]+M2[9]*M3[1]+M2[2]*M3[10]+M2[10]*M3[2]+M2[3]*M3[11]+M2[11]*M3[3]
    C.flat[43] = M2[0]*M3[16]+M2[4]*M3[12]+M2[1]*M3[17]+M2[5]*M3[13]+M2[2]*M3[18]+M2[6]*M3[14]+M2[3]*M3[19]+M2[7]*M3[15]
    C.flat[41] = M2[0]*M3[20]+M2[8]*M3[12]+M2[1]*M3[21]+M2[9]*M3[13]+M2[2]*M3[22]+M2[10]*M3[14]+M2[3]*M3[23]+M2[11]*M3[15]
    C.flat[47] = M2[0]*M3[24]+M2[12]*M3[12]+M2[1]*M3[25]+M2[13]*M3[13]+M2[2]*M3[26]+M2[14]*M3[14]+M2[3]*M3[27]+M2[15]*M3[15]
    C.flat[55] = M2[0]*M3[28]+M2[12]*M3[0]+M2[1]*M3[29]+M2[13]*M3[1]+M2[2]*M3[30]+M2[14]*M3[2]+M2[3]*M3[31]+M2[15]*M3[3]
    C.flat[53] = M2[4]*M3[8]+M2[8]*M3[4]+M2[5]*M3[9]+M2[9]*M3[5]+M2[6]*M3[10]+M2[10]*M3[6]+M2[7]*M3[11]+M2[11]*M3[7]
    C.flat[44] = M2[4]*M3[20]+M2[8]*M3[16]+M2[5]*M3[21]+M2[9]*M3[17]+M2[6]*M3[22]+M2[10]*M3[18]+M2[7]*M3[23]+M2[11]*M3[19]
    C.flat[52] = M2[4]*M3[24]+M2[12]*M3[16]+M2[5]*M3[25]+M2[13]*M3[17]+M2[6]*M3[26]+M2[14]*M3[18]+M2[7]*M3[27]+M2[15]*M3[19]
    C.flat[58] = M2[4]*M3[28]+M2[12]*M3[4]+M2[5]*M3[29]+M2[13]*M3[5]+M2[6]*M3[30]+M2[14]*M3[6]+M2[7]*M3[31]+M2[15]*M3[7]
    C.flat[49] = M2[8]*M3[24]+M2[12]*M3[20]+M2[9]*M3[25]+M2[13]*M3[21]+M2[10]*M3[26]+M2[14]*M3[22]+M2[11]*M3[27]+M2[15]*M3[23]
    C.flat[57] = M2[8]*M3[28]+M2[12]*M3[8]+M2[9]*M3[29]+M2[13]*M3[9]+M2[10]*M3[30]+M2[14]*M3[10]+M2[11]*M3[31]+M2[15]*M3[11]

    C = C/np.sqrt(np.sum(C*np.conj(C),axis=1,keepdims=True))

    def U(w,x,y,z):
        return np.array([w**2*x,w*x*y,y**2*x,w*x*z,z*y*x,z**2*x,w**2,x*w,y*w,x*y,y**2,z*w,x*z,y*z,z**2,w,x,y,z,1])

    return C,U