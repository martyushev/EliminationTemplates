import numpy as np
from scipy.sparse import csr_matrix
from scipy.linalg import lu, solve, eig

# Input: coefficient matrix C of size 6x16
# Output: solution matrix S of size 6x26

def red_66x92_r6p(C):
    M = csr_matrix((C.flat[[0,1,3,4,6,7,9,10,12,13,14,15,2,5,8,11,0,1,3,4,6,7,9,10,12,13,14,15,2,5,8,11,0,1,3,4,9,10,6,7,12,13,14,15,2,5,11,8,0,1,6,7,9,10,3,4,12,13,14,15,2,8,11,5,0,1,3,4,6,7,9,10,12,13,14,15,2,5,8,11,0,1,3,4,6,7,9,10,12,13,14,15,2,5,11,8,0,1,6,7,9,10,3,4,12,13,14,15,2,8,11,5,0,1,3,4,6,7,9,10,12,13,14,15,2,8,11,5,0,1,3,4,6,7,9,10,12,13,14,15,2,5,11,8,0,1,3,4,6,7,9,10,12,13,14,15,2,5,8,11,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,19,20,22,23,25,26,28,29,30,31,18,21,24,27,16,17,19,20,22,23,25,26,28,29,30,31,18,21,24,27,16,17,19,20,25,26,22,23,28,29,30,31,18,21,27,24,16,17,22,23,25,26,19,20,28,29,30,31,18,24,27,21,16,17,19,20,22,23,25,26,28,29,30,31,18,21,24,27,16,17,19,20,22,23,25,26,28,29,30,31,18,21,27,24,16,17,22,23,25,26,19,20,28,29,30,31,18,24,27,21,16,17,19,20,22,23,25,26,28,29,30,31,18,24,27,21,16,17,19,20,22,23,25,26,28,29,30,31,18,21,27,24,16,17,19,20,22,23,25,26,28,29,30,31,18,21,24,27,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,35,36,38,39,41,42,44,45,46,47,34,37,40,43,32,33,35,36,38,39,41,42,44,45,46,47,34,37,40,43,32,33,35,36,41,42,38,39,44,45,46,47,34,37,43,40,32,33,38,39,41,42,35,36,44,45,46,47,34,40,43,37,32,33,35,36,38,39,41,42,44,45,46,47,34,37,40,43,32,33,35,36,38,39,41,42,44,45,46,47,34,37,43,40,32,33,38,39,41,42,35,36,44,45,46,47,34,40,43,37,32,33,35,36,38,39,41,42,44,45,46,47,34,40,43,37,32,33,35,36,38,39,41,42,44,45,46,47,34,37,43,40,32,33,35,36,38,39,41,42,44,45,46,47,34,37,40,43,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,51,52,54,55,57,58,60,61,62,63,50,53,56,59,48,49,51,52,54,55,57,58,60,61,62,63,50,53,56,59,48,49,51,52,57,58,54,55,60,61,62,63,50,53,59,56,48,49,54,55,57,58,51,52,60,61,62,63,50,56,59,53,48,49,51,52,54,55,57,58,60,61,62,63,50,53,56,59,48,49,51,52,54,55,57,58,60,61,62,63,50,53,59,56,48,49,54,55,57,58,51,52,60,61,62,63,50,56,59,53,48,49,51,52,54,55,57,58,60,61,62,63,50,56,59,53,48,49,51,52,54,55,57,58,60,61,62,63,50,53,59,56,48,49,51,52,54,55,57,58,60,61,62,63,50,53,56,59,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,67,68,70,71,73,74,76,77,78,79,66,69,72,75,64,65,67,68,70,71,73,74,76,77,78,79,66,69,72,75,64,65,67,68,73,74,70,71,76,77,78,79,66,69,75,72,64,65,70,71,73,74,67,68,76,77,78,79,66,72,75,69,64,65,67,68,70,71,73,74,76,77,78,79,66,69,72,75,64,65,67,68,70,71,73,74,76,77,78,79,66,69,75,72,64,65,70,71,73,74,67,68,76,77,78,79,66,72,75,69,64,65,67,68,70,71,73,74,76,77,78,79,66,72,75,69,64,65,67,68,70,71,73,74,76,77,78,79,66,69,75,72,64,65,67,68,70,71,73,74,76,77,78,79,66,69,72,75,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,83,84,86,87,89,90,92,93,94,95,82,85,88,91,80,81,83,84,86,87,89,90,92,93,94,95,82,85,88,91,80,81,83,84,89,90,86,87,92,93,94,95,82,85,91,88,80,81,86,87,89,90,83,84,92,93,94,95,82,88,91,85,80,81,83,84,86,87,89,90,92,93,94,95,82,85,88,91,80,81,83,84,86,87,89,90,92,93,94,95,82,85,91,88,80,81,86,87,89,90,83,84,92,93,94,95,82,88,91,85,80,81,83,84,86,87,89,90,92,93,94,95,82,88,91,85,80,81,83,84,86,87,89,90,92,93,94,95,82,85,91,88,80,81,83,84,86,87,89,90,92,93,94,95,82,85,88,91,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95]],([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,33,33,33,33,33,33,33,33,33,33,33,33,33,33,33,33,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,35,35,35,35,35,35,35,35,35,35,35,35,35,35,35,35,36,36,36,36,36,36,36,36,36,36,36,36,36,36,36,36,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,38,39,39,39,39,39,39,39,39,39,39,39,39,39,39,39,39,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,41,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,43,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,44,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,46,46,46,46,46,46,46,46,46,46,46,46,46,46,46,46,47,47,47,47,47,47,47,47,47,47,47,47,47,47,47,47,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,54,54,54,54,54,54,54,54,54,54,54,54,54,54,54,54,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,56,56,56,56,56,56,56,56,56,56,56,56,56,56,56,56,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,58,58,58,58,58,58,58,58,58,58,58,58,58,58,58,58,59,59,59,59,59,59,59,59,59,59,59,59,59,59,59,59,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,60,61,61,61,61,61,61,61,61,61,61,61,61,61,61,61,61,62,62,62,62,62,62,62,62,62,62,62,62,62,62,62,62,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,63,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65],[34,35,36,37,38,39,40,41,62,63,64,65,81,82,83,84,24,25,26,27,30,31,34,35,56,57,59,62,76,77,79,81,26,27,28,29,36,37,49,50,57,58,60,63,77,78,82,91,30,31,32,33,38,39,49,50,59,60,61,64,79,80,83,91,6,7,8,9,14,15,24,25,44,45,48,56,69,70,73,76,10,11,12,13,18,19,28,29,46,47,52,58,71,72,78,89,20,21,22,23,32,33,42,43,53,54,55,61,74,75,80,90,14,15,16,17,20,21,30,31,48,51,53,59,73,74,79,88,8,9,10,11,16,17,26,27,45,46,51,57,70,71,77,88,16,17,18,19,42,43,49,50,51,52,54,60,88,89,90,91,0,1,2,3,4,5,66,67,68,85,86,87,88,89,90,91,34,35,36,37,38,39,40,41,62,63,64,65,81,82,83,84,24,25,26,27,30,31,34,35,56,57,59,62,76,77,79,81,26,27,28,29,36,37,49,50,57,58,60,63,77,78,82,91,30,31,32,33,38,39,49,50,59,60,61,64,79,80,83,91,6,7,8,9,14,15,24,25,44,45,48,56,69,70,73,76,10,11,12,13,18,19,28,29,46,47,52,58,71,72,78,89,20,21,22,23,32,33,42,43,53,54,55,61,74,75,80,90,14,15,16,17,20,21,30,31,48,51,53,59,73,74,79,88,8,9,10,11,16,17,26,27,45,46,51,57,70,71,77,88,16,17,18,19,42,43,49,50,51,52,54,60,88,89,90,91,0,1,2,3,4,5,66,67,68,85,86,87,88,89,90,91,34,35,36,37,38,39,40,41,62,63,64,65,81,82,83,84,24,25,26,27,30,31,34,35,56,57,59,62,76,77,79,81,26,27,28,29,36,37,49,50,57,58,60,63,77,78,82,91,30,31,32,33,38,39,49,50,59,60,61,64,79,80,83,91,6,7,8,9,14,15,24,25,44,45,48,56,69,70,73,76,10,11,12,13,18,19,28,29,46,47,52,58,71,72,78,89,20,21,22,23,32,33,42,43,53,54,55,61,74,75,80,90,14,15,16,17,20,21,30,31,48,51,53,59,73,74,79,88,8,9,10,11,16,17,26,27,45,46,51,57,70,71,77,88,16,17,18,19,42,43,49,50,51,52,54,60,88,89,90,91,0,1,2,3,4,5,66,67,68,85,86,87,88,89,90,91,34,35,36,37,38,39,40,41,62,63,64,65,81,82,83,84,24,25,26,27,30,31,34,35,56,57,59,62,76,77,79,81,26,27,28,29,36,37,49,50,57,58,60,63,77,78,82,91,30,31,32,33,38,39,49,50,59,60,61,64,79,80,83,91,6,7,8,9,14,15,24,25,44,45,48,56,69,70,73,76,10,11,12,13,18,19,28,29,46,47,52,58,71,72,78,89,20,21,22,23,32,33,42,43,53,54,55,61,74,75,80,90,14,15,16,17,20,21,30,31,48,51,53,59,73,74,79,88,8,9,10,11,16,17,26,27,45,46,51,57,70,71,77,88,16,17,18,19,42,43,49,50,51,52,54,60,88,89,90,91,0,1,2,3,4,5,66,67,68,85,86,87,88,89,90,91,34,35,36,37,38,39,40,41,62,63,64,65,81,82,83,84,24,25,26,27,30,31,34,35,56,57,59,62,76,77,79,81,26,27,28,29,36,37,49,50,57,58,60,63,77,78,82,91,30,31,32,33,38,39,49,50,59,60,61,64,79,80,83,91,6,7,8,9,14,15,24,25,44,45,48,56,69,70,73,76,10,11,12,13,18,19,28,29,46,47,52,58,71,72,78,89,20,21,22,23,32,33,42,43,53,54,55,61,74,75,80,90,14,15,16,17,20,21,30,31,48,51,53,59,73,74,79,88,8,9,10,11,16,17,26,27,45,46,51,57,70,71,77,88,16,17,18,19,42,43,49,50,51,52,54,60,88,89,90,91,0,1,2,3,4,5,66,67,68,85,86,87,88,89,90,91,34,35,36,37,38,39,40,41,62,63,64,65,81,82,83,84,24,25,26,27,30,31,34,35,56,57,59,62,76,77,79,81,26,27,28,29,36,37,49,50,57,58,60,63,77,78,82,91,30,31,32,33,38,39,49,50,59,60,61,64,79,80,83,91,6,7,8,9,14,15,24,25,44,45,48,56,69,70,73,76,10,11,12,13,18,19,28,29,46,47,52,58,71,72,78,89,20,21,22,23,32,33,42,43,53,54,55,61,74,75,80,90,14,15,16,17,20,21,30,31,48,51,53,59,73,74,79,88,8,9,10,11,16,17,26,27,45,46,51,57,70,71,77,88,16,17,18,19,42,43,49,50,51,52,54,60,88,89,90,91,0,1,2,3,4,5,66,67,68,85,86,87,88,89,90,91])),shape=(66,92))
    M = M.toarray()

    P,L,_ = lu(M[:,:42])
    M = solve(np.concatenate((P@L,P[:,42:]),axis=1),M[:,42:])
    M = M[-24:,:]

    T0 = np.zeros((26,26))
    T0[[0,1,3,4,5,6,7,19,20,22,23,8,24,9,10,11,12,13,25,14,15,16,17,18],:] = -M[:,24:]
    T0.flat[[76,571]] = 1
    T1 = np.zeros((26,26))
    T1[np.ix_([0,1,3,4,5,6,7,19,20,22,23,8,24,9,10,11,12,13,25,14,15,16,17,18],[0,1,3,4,5,6,7,19,20,22,23,8,24,9,10,11,12,13,25,14,15,16,17,18])] = M[:,:24]
    T1.flat[[54,567]] = 1

    _,V = eig(T0,T1)
    S = V[19:25,:]/np.tile(V[25,:],(6,1))
    S = S[:,np.all(np.isfinite(S),axis=0)]

    return S