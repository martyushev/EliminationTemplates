% Input: coefficient matrix C of size 9x40
% Output: solution matrix S of size 4x12

function S = red_28x40_p4p_fr_iccv17(C)

    M = sparse([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28],[1,2,3,5,6,8,11,12,13,14,16,18,19,20,21,22,26,29,33,37,2,3,4,6,7,9,13,14,15,16,17,19,21,23,24,27,30,31,34,38,5,6,7,8,9,10,18,19,29,30,31,32,33,34,35,36,37,38,39,40,11,13,15,20,21,22,23,24,25,26,27,28,29,30,32,36,37,38,39,40,1,2,3,5,6,8,11,12,13,14,16,18,19,20,21,22,26,29,33,37,2,3,4,6,7,9,13,14,15,16,17,19,21,23,24,27,30,31,34,38,5,6,7,8,9,10,18,19,29,30,31,32,33,34,35,36,37,38,39,40,11,13,15,20,21,22,23,24,25,26,27,28,29,30,32,36,37,38,39,40,2,3,4,6,7,9,13,15,23,30,5,6,7,8,9,10,29,30,32,36,11,13,15,22,23,25,29,30,32,36,12,14,16,18,19,20,21,26,33,37,14,16,17,19,21,24,27,31,34,38,18,19,31,33,34,35,37,38,39,40,20,21,24,26,27,28,37,38,39,40,1,2,3,5,6,8,11,13,22,29,2,3,4,6,7,9,13,15,23,30,5,6,7,8,9,10,29,30,32,36,11,13,15,22,23,25,29,30,32,36,12,14,16,18,19,20,21,26,33,37,14,16,17,19,21,24,27,31,34,38,18,19,31,33,34,35,37,38,39,40,20,21,24,26,27,28,37,38,39,40,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40],C([91,109,127,154,172,199,235,244,253,262,271,289,298,325,334,316,352,280,307,343,91,109,127,154,172,199,235,244,253,262,271,289,325,316,334,352,280,298,307,343,91,109,127,154,172,199,244,262,235,253,271,280,289,298,307,316,325,334,343,352,91,109,127,244,262,235,253,271,316,325,334,352,154,172,199,280,289,298,307,343,92,110,128,155,173,200,236,245,254,263,272,290,299,326,335,317,353,281,308,344,92,110,128,155,173,200,236,245,254,263,272,290,326,317,335,353,281,299,308,344,92,110,128,155,173,200,245,263,236,254,272,281,290,299,308,317,326,335,344,353,92,110,128,245,263,236,254,272,317,326,335,353,155,173,200,281,290,299,308,344,246,264,273,291,300,309,327,336,354,345,246,264,273,291,300,309,327,336,345,354,246,264,273,327,336,354,291,300,309,345,246,264,273,291,300,327,336,354,309,345,246,264,273,291,327,336,354,300,309,345,246,264,273,291,300,309,327,336,345,354,246,264,273,327,336,354,291,300,309,345,247,265,274,292,301,310,328,337,355,346,247,265,274,292,301,310,328,337,355,346,247,265,274,292,301,310,328,337,346,355,247,265,274,328,337,355,292,301,310,346,247,265,274,292,301,328,337,355,310,346,247,265,274,292,328,337,355,301,310,346,247,265,274,292,301,310,328,337,346,355,247,265,274,328,337,355,292,301,310,346,5,14,23,32,41,50,59,68,77,86,95,104,113,122,131,140,149,167,185,248,266,239,257,275,320,329,338,356,158,176,194,203,212,221,230,284,293,302,311,347,6,15,24,33,42,51,60,69,78,87,96,105,114,123,132,141,150,168,186,249,267,240,258,276,321,330,339,357,159,177,195,204,213,222,231,285,294,303,312,348,7,16,25,34,43,52,61,70,79,88,97,106,115,124,133,142,151,169,187,250,268,241,259,277,322,331,340,358,160,178,196,205,214,223,232,286,295,304,313,349,8,17,26,35,44,53,62,71,80,89,98,107,116,125,134,143,152,170,188,251,269,242,260,278,323,332,341,359,161,179,197,206,215,224,233,287,296,305,314,350,9,18,27,36,45,54,63,72,81,90,99,108,117,126,135,144,153,171,189,252,270,243,261,279,324,333,342,360,162,180,198,207,216,225,234,288,297,306,315,351]),28,40);

    [L,~,P] = lu(M(:,1:21));
    P = P';
    M = [P*L P(:,22:end)]\M(:,22:end);
    M = M(end-6:end,:);

    T0 = zeros(12);
    T0([1,2,3,8,9,10,12],:) = -M(:,8:end);
    T0([88,101,114,127,143]) = 1;
    T1 = zeros(12);
    T1([1,2,3,8,9,10,12],[1,2,3,8,9,10,12]) = M(:,1:7);
    T1([40,53,66,79,131]) = 1;

    [V,~] = eig(T0,T1);
    S = V(8:11,:)./repmat(V(12,:),4,1);

    I = ~any(isnan(S)) & ~any(isinf(S));
    %I = I & ~any(imag(S)); % uncomment this line for real roots only
    S = S(:,I);

end