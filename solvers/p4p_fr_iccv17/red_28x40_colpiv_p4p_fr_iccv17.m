% Input: coefficient matrix C of size 9x40
% Output: solution matrix S of size 4x12

function S = red_28x40_colpiv_p4p_fr_iccv17(C)

    ix = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28];
    jx = [1,2,3,5,6,7,9,10,12,13,15,18,21,22,24,27,28,30,33,37,2,3,4,6,7,8,10,11,14,15,16,19,22,23,25,29,30,31,34,38,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,9,10,11,12,13,14,15,16,17,18,19,20,27,29,32,36,37,38,39,40,1,2,3,5,6,7,9,10,12,13,15,18,21,22,24,27,28,30,33,37,2,3,4,6,7,8,10,11,14,15,16,19,22,23,25,29,30,31,34,38,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,9,10,11,12,13,14,15,16,17,18,19,20,27,29,32,36,37,38,39,40,2,3,4,10,11,14,22,23,25,29,21,22,23,24,25,26,27,29,32,36,9,10,11,12,14,17,27,29,32,36,5,6,7,13,15,18,28,30,33,37,6,7,8,15,16,19,30,31,34,38,28,30,31,33,34,35,37,38,39,40,13,15,16,18,19,20,37,38,39,40,1,2,3,9,10,12,21,22,24,27,2,3,4,10,11,14,22,23,25,29,21,22,23,24,25,26,27,29,32,36,9,10,11,12,14,17,27,29,32,36,5,6,7,13,15,18,28,30,33,37,6,7,8,15,16,19,30,31,34,38,28,30,31,33,34,35,37,38,39,40,13,15,16,18,19,20,37,38,39,40,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40];
    kx = [91,109,127,244,262,271,235,253,316,325,334,352,154,172,199,280,289,298,307,343,91,109,127,244,262,271,235,253,316,325,334,352,154,172,199,280,289,298,307,343,91,109,127,154,172,199,235,244,253,262,271,280,289,298,307,316,325,334,343,352,91,109,127,235,244,253,262,271,316,325,334,352,154,172,199,280,289,298,307,343,92,110,128,245,263,272,236,254,317,326,335,353,155,173,200,281,290,299,308,344,92,110,128,245,263,272,236,254,317,326,335,353,155,173,200,281,290,299,308,344,92,110,128,155,173,200,236,245,254,263,272,281,290,299,308,317,326,335,344,353,92,110,128,236,245,254,263,272,317,326,335,353,155,173,200,281,290,299,308,344,246,264,273,327,336,354,291,300,309,345,246,264,273,291,300,309,327,336,345,354,246,264,273,327,336,354,291,300,309,345,246,264,273,327,336,354,291,300,309,345,246,264,273,327,336,354,291,300,309,345,246,264,273,291,300,309,327,336,345,354,246,264,273,327,336,354,291,300,309,345,247,265,274,328,337,355,292,301,310,346,247,265,274,328,337,355,292,301,310,346,247,265,274,292,301,310,328,337,346,355,247,265,274,328,337,355,292,301,310,346,247,265,274,328,337,355,292,301,310,346,247,265,274,328,337,355,292,301,310,346,247,265,274,292,301,310,328,337,346,355,247,265,274,328,337,355,292,301,310,346,5,14,23,32,104,122,140,149,95,113,131,239,248,257,266,275,320,329,338,356,41,50,59,68,77,86,158,167,176,185,194,203,212,221,230,284,293,302,311,347,6,15,24,33,105,123,141,150,96,114,132,240,249,258,267,276,321,330,339,357,42,51,60,69,78,87,159,168,177,186,195,204,213,222,231,285,294,303,312,348,7,16,25,34,106,124,142,151,97,115,133,241,250,259,268,277,322,331,340,358,43,52,61,70,79,88,160,169,178,187,196,205,214,223,232,286,295,304,313,349,8,17,26,35,107,125,143,152,98,116,134,242,251,260,269,278,323,332,341,359,44,53,62,71,80,89,161,170,179,188,197,206,215,224,233,287,296,305,314,350,9,18,27,36,108,126,144,153,99,117,135,243,252,261,270,279,324,333,342,360,45,54,63,72,81,90,162,171,180,189,198,207,216,225,234,288,297,306,315,351];
    M = sparse(ix,jx,C(kx),28,40);

    [L,~,P] = lu(M(:,1:8));
    P = P';
    M = [P*L P(:,9:end)]\M(:,9:end);
    M = full(M(9:end,:));

    [L,U,P] = lu(M(:,1:12));
    P = P';
    M = [P*L P(:,13:end)]\M(:,13:end);
    M1 = M(1:12,:);
    M2 = M(13:end,:);

    [Q,R,P] = qr(M2(:,1:end-5));
    A = U\[M1(:,1:end-5)*P M1(:,end-4:end)];
    B = R(:,1:8)\[R(:,9:end) Q'*M2(:,end-4:end)];
    M = [-A(:,end-11:end)+A(:,1:end-12)*B; -B];

    P1 = [21:32 (1:15)*P 16:20];
    P2 = [21,22,23,7,9,12,24,25,26,27,28,16,17,18,19,29,30,31,20,32];
    T = getT(M,P1(1:end-12),P1(end-11:end),P2);

    [V,~] = eig(T);
    S = V(8:11,:)./repmat(V(12,:),4,1);

    I = ~isnan(S(1,:)) & ~isinf(S(1,:));
    %I = I & ~imag(S(1,:)); % uncomment this line for real roots only
    S = S(:,I);

end