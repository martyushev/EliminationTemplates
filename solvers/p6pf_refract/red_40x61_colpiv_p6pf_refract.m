% Input: coefficient matrix C of size 4x27
% Output: solution matrix S of size 4x42

function S = red_40x61_colpiv_p6pf_refract(C)

    ix = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,5,5,5,5,5,5,6,6,6,6,6,6,7,7,7,7,7,7,8,8,8,8,8,8,9,9,9,9,9,9,10,10,10,10,10,10,11,11,11,11,11,11,12,12,12,12,12,12,13,13,13,13,13,13,14,14,14,14,14,14,15,15,15,15,15,15,16,16,16,16,16,16,17,17,17,17,17,17,18,18,18,18,18,18,19,19,19,19,19,19,20,20,20,20,20,20,21,21,21,21,21,21,22,22,22,22,22,22,23,23,23,23,23,23,24,24,24,24,24,24,25,25,25,25,25,25,26,26,26,26,26,26,27,27,27,27,27,27,28,28,28,28,28,28,29,29,29,29,29,29,30,30,30,30,30,30,31,31,31,31,31,31,32,32,32,32,32,32,33,33,33,33,33,33,34,34,34,34,34,34,35,35,35,35,35,35,36,36,36,36,36,36,37,37,37,37,37,37,38,38,38,38,38,38,39,39,39,39,39,39,40,40,40,40,40,40];
    jx = [5,6,7,9,10,11,13,14,16,19,22,24,27,29,32,33,35,36,38,41,44,45,47,50,55,57,1,3,6,8,11,12,14,15,17,20,23,25,28,30,33,34,36,37,39,42,45,46,48,51,56,58,2,4,8,9,14,15,16,17,18,21,25,26,30,31,36,37,38,39,40,43,48,49,52,57,59,61,7,8,14,22,36,48,2,8,15,23,37,49,3,9,17,25,39,58,27,35,36,41,50,53,28,36,37,42,51,54,30,38,39,43,52,60,32,47,48,50,53,55,33,48,49,51,54,56,36,52,57,58,60,61,13,14,19,44,53,55,14,15,20,45,54,56,16,17,21,48,60,61,5,8,14,24,36,48,2,6,15,25,37,49,3,8,17,26,39,58,29,32,36,41,50,53,30,33,37,42,51,54,31,36,39,43,52,60,35,44,48,50,53,55,36,45,49,51,54,56,38,48,52,58,60,61,10,14,19,47,53,55,11,15,20,48,54,56,14,17,21,57,60,61,23,25,26,30,36,48,6,8,9,14,36,48,1,2,3,15,37,49,2,3,4,17,39,58,33,36,38,41,50,53,34,37,39,42,51,54,37,39,40,43,52,60,45,48,50,53,55,57,46,49,51,54,56,58,49,52,58,59,60,61,11,14,16,19,53,55,12,15,17,20,54,56,15,17,18,21,60,61];
    kx = [17,21,25,29,77,81,85,89,93,105,1,5,9,13,33,37,41,45,49,53,57,61,65,73,101,69,21,29,17,25,77,81,85,89,93,105,1,5,9,13,33,37,41,45,49,53,57,61,65,73,101,69,21,29,17,25,77,81,85,89,93,105,1,5,9,13,33,37,41,45,49,53,57,61,73,65,69,101,86,90,106,58,98,102,90,86,106,58,98,102,90,86,106,58,98,102,58,86,90,98,102,106,58,86,90,98,102,106,58,86,90,98,102,106,58,86,90,98,102,106,58,86,90,98,102,106,58,98,86,90,102,106,86,90,106,58,98,102,86,90,106,58,98,102,86,90,106,58,98,102,79,91,107,67,99,103,91,79,107,67,99,103,91,79,107,67,99,103,67,79,91,99,103,107,67,79,91,99,103,107,67,79,91,99,103,107,67,79,91,99,103,107,67,79,91,99,103,107,67,79,99,91,103,107,79,91,107,67,99,103,79,91,107,67,99,103,79,91,107,67,99,103,84,92,96,100,104,108,84,92,96,108,100,104,84,92,96,108,100,104,84,92,96,108,100,104,84,92,96,100,104,108,84,92,96,100,104,108,84,92,96,100,104,108,84,92,100,104,108,96,84,92,100,104,108,96,84,100,92,96,104,108,84,92,96,108,100,104,84,92,96,108,100,104,84,92,96,108,100,104];
    M = sparse(ix,jx,C(kx),40,61);

    [L,~,P] = lu(M(:,1:4));
    P = P';
    M = [P*L P(:,5:end)]\M(:,5:end);
    M = full(M(5:end,:));

    [L,U,P] = lu(M(:,1:17));
    P = P';
    M = [P*L P(:,18:end)]\M(:,18:end);
    M1 = M(1:17,:);
    M2 = M(18:end,:);

    [Q,R,P] = qr(M2(:,1:end-5));
    A = U\[M1(:,1:end-5)*P M1(:,end-4:end)];
    B = R(:,1:19)\[R(:,20:end) Q'*M2(:,end-4:end)];
    M = [-A(:,end-20:end)+A(:,1:end-21)*B; -B];

    P1 = [41:57 (1:35)*P 36:40];
    P2 = [41,42,43,44,45,11,12,14,15,17,23,24,25,26,27,28,36,37,38,29,30,31,46,47,48,49,50,51,32,33,39,34,35,55,56,52,53,54,40,57];
    T = getT(M,P1(1:end-21),P1(end-20:end),P2);

    [V,~] = eig(T);
    S = V(17:20,:)./repmat(V(21,:),4,1);

    I = ~isnan(S(1,:)) & ~isinf(S(1,:));
    %I = I & ~imag(S(1,:)); % uncomment this line for real roots only
    S = S(:,I);
    
    y = sqrt(S(3,:));
    wx = S([1,2],:)./y;
    z = S(4,:);
    S = [wx -wx; y -y; z z];

end