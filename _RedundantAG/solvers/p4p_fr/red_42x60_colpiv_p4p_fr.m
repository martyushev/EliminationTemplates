% Input: coefficient matrix C of size 4x20
% Output: solution matrix S of size 4x18

function S = red_42x60_colpiv_p4p_fr(C)

    ix = [1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,29,29,29,29,29,29,29,29,29,29,30,30,30,30,30,30,30,30,30,30,31,31,31,31,31,31,31,31,31,31,32,32,32,32,32,32,32,32,32,32,33,33,33,33,33,33,33,33,33,33,34,34,34,34,34,34,34,34,34,34,35,35,35,35,35,35,35,35,35,35,36,36,36,36,36,36,36,36,36,36,37,37,37,37,37,37,37,37,37,37,38,38,38,38,38,38,38,38,38,38,39,39,39,39,39,39,39,39,39,39,40,40,40,40,40,40,40,40,40,40,41,41,41,41,41,41,41,41,41,41,42,42,42,42,42,42,42,42,42,42];
    jx = [1,2,3,11,12,16,29,30,32,39,29,30,31,32,33,34,39,41,44,53,2,3,4,12,13,18,32,33,34,44,5,11,12,14,16,21,35,36,39,48,35,36,37,39,41,44,48,50,53,57,6,7,8,15,17,22,38,40,43,52,11,12,13,16,18,23,39,41,44,53,38,40,42,43,45,46,52,54,55,59,7,8,9,17,19,24,43,45,46,55,10,15,17,20,22,25,47,49,52,56,14,16,18,21,23,26,48,50,53,57,47,49,51,52,54,55,56,58,59,60,15,17,19,22,24,27,52,54,55,59,20,22,24,25,27,28,56,58,59,60,1,2,3,6,7,8,11,12,15,16,17,22,29,30,32,38,39,40,43,52,29,30,31,32,33,34,38,39,40,41,42,43,44,45,46,52,53,54,55,59,2,3,4,7,8,9,12,13,17,18,19,24,32,33,34,43,44,45,46,55,5,10,11,12,14,15,16,17,20,21,22,25,35,36,39,47,48,49,52,56,35,36,37,39,41,44,47,48,49,50,51,52,53,54,55,56,57,58,59,60,11,12,13,15,16,17,18,19,22,23,24,27,39,41,44,52,53,54,55,59,14,16,18,20,21,22,23,24,25,26,27,28,48,50,53,56,57,58,59,60,1,2,3,6,7,8,11,12,15,16,17,22,29,30,32,38,39,40,43,52,29,30,31,32,33,34,38,39,40,41,42,43,44,45,46,52,53,54,55,59,2,3,4,7,8,9,12,13,17,18,19,24,32,33,34,43,44,45,46,55,5,10,11,12,14,15,16,17,20,21,22,25,35,36,39,47,48,49,52,56,35,36,37,39,41,44,47,48,49,50,51,52,53,54,55,56,57,58,59,60,11,12,13,15,16,17,18,19,22,23,24,27,39,41,44,52,53,54,55,59,14,16,18,20,21,22,23,24,25,26,27,28,48,50,53,56,57,58,59,60,1,2,3,11,12,16,29,30,32,39,29,30,31,32,33,34,39,41,44,53,2,3,4,12,13,18,32,33,34,44,5,11,12,14,16,21,35,36,39,48,35,36,37,39,41,44,48,50,53,57,6,7,8,15,17,22,38,40,43,52,11,12,13,16,18,23,39,41,44,53,38,40,42,43,45,46,52,54,55,59,7,8,9,17,19,24,43,45,46,55,10,15,17,20,22,25,47,49,52,56,14,16,18,21,23,26,48,50,53,57,47,49,51,52,54,55,56,58,59,60,15,17,19,22,24,27,52,54,55,59,20,22,24,25,27,28,56,58,59,60];
    kx = [25,45,57,61,73,77,33,41,53,69,25,33,41,45,53,57,61,69,73,77,25,45,57,61,73,77,33,41,53,69,25,45,57,61,73,77,33,41,53,69,25,33,41,45,53,57,61,69,73,77,25,45,57,61,73,77,33,41,53,69,25,45,57,61,73,77,33,41,53,69,25,33,41,45,53,57,61,69,73,77,25,45,57,61,73,77,33,41,53,69,25,45,57,61,73,77,33,41,53,69,25,45,57,61,73,77,33,41,53,69,25,33,41,45,53,57,61,69,73,77,25,45,57,61,73,77,33,41,53,69,25,45,57,61,73,77,33,41,53,69,2,14,22,26,46,58,30,50,62,66,74,78,6,10,18,34,38,42,54,70,2,6,10,14,18,22,26,30,34,38,42,46,50,54,58,62,66,70,74,78,2,14,22,26,46,58,30,50,62,66,74,78,6,10,18,34,38,42,54,70,2,26,14,22,30,46,50,58,62,66,74,78,6,10,18,34,38,42,54,70,2,6,10,14,18,22,26,30,34,38,42,46,50,54,58,62,66,70,74,78,2,14,22,26,30,46,50,58,62,66,74,78,6,10,18,34,38,42,54,70,2,14,22,26,30,46,50,58,62,66,74,78,6,10,18,34,38,42,54,70,3,15,23,27,47,59,31,51,63,67,75,79,7,11,19,35,39,43,55,71,3,7,11,15,19,23,27,31,35,39,43,47,51,55,59,63,67,71,75,79,3,15,23,27,47,59,31,51,63,67,75,79,7,11,19,35,39,43,55,71,3,27,15,23,31,47,51,59,63,67,75,79,7,11,19,35,39,43,55,71,3,7,11,15,19,23,27,31,35,39,43,47,51,55,59,63,67,71,75,79,3,15,23,27,31,47,51,59,63,67,75,79,7,11,19,35,39,43,55,71,3,15,23,27,31,47,51,59,63,67,75,79,7,11,19,35,39,43,55,71,28,48,60,64,76,80,36,44,56,72,28,36,44,48,56,60,64,72,76,80,28,48,60,64,76,80,36,44,56,72,28,48,60,64,76,80,36,44,56,72,28,36,44,48,56,60,64,72,76,80,28,48,60,64,76,80,36,44,56,72,28,48,60,64,76,80,36,44,56,72,28,36,44,48,56,60,64,72,76,80,28,48,60,64,76,80,36,44,56,72,28,48,60,64,76,80,36,44,56,72,28,48,60,64,76,80,36,44,56,72,28,36,44,48,56,60,64,72,76,80,28,48,60,64,76,80,36,44,56,72,28,48,60,64,76,80,36,44,56,72];
    M = sparse(ix,jx,C(kx),42,60);

    [L,~,P] = lu(M(:,1:10));
    P = P';
    M = [P*L P(:,11:end)]\M(:,11:end);
    M = full(M(11:end,:));

    [L,U,P] = lu(M(:,1:18));
    P = P';
    M = [P*L P(:,19:end)]\M(:,19:end);
    M1 = M(1:18,:);
    M2 = M(19:end,:);

    [Q,R,P] = qr(M2(:,1:end-5));
    A = U\[M1(:,1:end-5)*P M1(:,end-4:end)];
    B = R(:,1:14)\[R(:,15:end) Q'*M2(:,end-4:end)];
    M = [-A(:,end-17:end)+A(:,1:end-18)*B; -B];

    P1 = [33:50 (1:27)*P 28:32];
    P2 = [33,11,13,34,16,35,36,20,22,37,38,24,25,26,39,40,27,41,42,43,28,29,30,44,45,31,46,47,48,32,49,50];
    T = getT(M,P1(1:end-18),P1(end-17:end),P2);

    [V,~] = eig(T);
    S = V(14:17,:)./repmat(V(18,:),4,1);

    I = ~isnan(S(1,:)) & ~isinf(S(1,:));
    %I = I & ~imag(S(1,:)); % uncomment this line for real roots only
    S = S(:,I);

end