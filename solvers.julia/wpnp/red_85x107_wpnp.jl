# Input: coefficient matrix C of size 4x24
# Output: solution matrix S of size 4x22

function red_85x107_wpnp(C::Array{Float64})

    M = sparse([1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,10,10,10,10,10,10,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,26,26,26,26,26,26,27,27,27,27,27,27,27,27,28,28,28,28,28,28,29,29,29,29,29,29,29,30,30,30,30,30,30,30,31,31,31,31,31,31,31,31,31,32,32,32,32,32,32,32,32,32,33,33,33,33,33,33,34,34,34,34,34,34,34,34,34,35,35,35,35,35,35,35,35,35,36,36,36,36,36,36,37,37,37,37,37,37,37,37,37,38,38,38,38,38,38,38,38,38,39,39,39,39,39,39,39,39,39,40,40,40,40,40,40,40,40,40,41,41,41,41,41,41,41,41,41,42,42,42,42,42,42,42,42,42,43,43,43,43,43,43,43,43,43,44,44,44,44,44,44,44,44,44,45,45,45,45,45,45,45,45,45,46,46,46,46,46,46,46,46,46,47,47,47,47,47,47,47,47,47,48,48,48,48,48,48,48,48,49,49,49,49,49,49,49,49,50,50,50,50,50,50,50,51,51,51,51,51,51,51,52,52,52,52,52,52,52,52,53,53,53,53,53,54,54,54,54,54,54,54,54,54,55,55,55,55,55,55,56,56,56,56,56,56,56,56,56,57,57,57,57,57,57,57,57,57,58,58,58,58,58,58,58,58,58,59,59,59,59,59,60,60,60,60,60,60,60,60,60,61,61,61,61,61,61,61,61,61,62,62,62,62,62,62,62,62,62,63,63,63,63,63,63,63,63,63,64,64,64,64,64,64,64,64,64,65,65,65,65,65,65,65,65,65,66,66,66,66,66,66,66,66,66,67,67,67,67,67,67,67,68,68,68,68,68,68,68,69,69,69,69,69,69,69,69,69,70,70,70,70,70,70,70,71,71,71,71,71,71,71,72,72,72,72,72,72,72,72,73,73,73,73,73,73,74,74,74,74,74,74,74,74,75,75,75,75,75,75,75,76,76,76,76,76,76,76,76,76,77,77,77,77,77,77,78,78,78,78,78,78,78,78,78,79,79,79,79,79,79,79,79,80,80,80,80,80,80,80,80,80,81,81,81,81,81,81,81,81,81,82,82,82,82,82,83,83,83,83,83,83,83,83,83,84,84,84,84,84,84,84,84,84,85,85,85,85,85,85,85,85,85],[1,2,3,13,27,46,47,49,61,4,6,11,27,37,59,86,88,93,5,7,12,28,39,60,61,71,86,8,9,14,45,61,62,72,88,10,12,30,62,63,73,89,15,17,26,39,53,90,91,93,97,16,18,27,41,65,71,74,91,20,22,29,45,58,92,93,94,100,21,23,71,72,75,93,25,27,72,73,76,94,31,33,45,74,75,77,97,34,38,88,92,99,101,102,106,35,39,75,76,79,100,36,40,48,61,68,69,80,93,101,43,46,62,69,70,81,94,102,51,54,87,93,95,103,105,106,107,52,55,71,78,80,83,88,97,105,57,72,80,81,84,86,89,100,106,64,75,83,84,85,91,94,104,107,3,11,13,48,49,50,62,6,16,18,27,54,55,86,91,7,17,19,28,55,56,60,65,9,22,24,60,61,71,86,11,25,27,87,88,89,94,12,26,28,30,61,62,72,88,14,29,62,63,73,89,22,31,33,45,90,91,93,97,23,32,65,71,74,91,26,35,39,92,93,94,100,27,37,41,71,72,75,93,36,51,54,66,87,95,96,99,103,38,52,55,88,96,97,98,101,105,39,53,74,75,77,97,40,54,56,61,67,68,74,78,98,44,57,86,89,99,100,101,102,106,45,58,75,76,79,100,46,59,60,62,68,69,75,80,101,48,61,63,69,70,76,81,87,102,59,64,91,94,103,104,105,106,107,65,72,77,78,80,83,86,90,105,71,73,79,80,81,84,88,92,106,74,76,82,83,84,85,93,95,107,1,2,3,11,27,44,46,48,88,4,6,11,25,37,57,59,87,92,5,7,12,26,39,59,86,88,93,8,9,14,29,45,87,88,89,94,15,17,26,35,53,64,90,92,95,16,18,27,37,90,91,93,97,17,19,28,39,65,71,74,91,22,24,45,71,72,75,93,26,28,30,72,73,76,94,31,33,45,58,95,97,100,104,32,74,75,77,97,36,40,48,87,93,99,101,102,106,37,41,75,76,79,100,38,42,49,68,69,71,80,88,101,44,47,50,69,70,72,81,89,102,52,55,88,92,97,103,105,106,107,53,77,79,82,104,54,56,61,74,78,80,83,93,105,59,60,62,75,80,81,84,94,106,65,72,77,83,84,85,90,100,107,1,2,3,6,27,38,40,46,86,4,6,11,16,37,52,54,59,90,5,7,12,17,39,54,55,86,91,8,9,14,22,45,59,86,88,93,10,12,26,87,88,89,94,11,13,27,61,62,72,88,20,22,29,31,58,64,90,92,95,21,23,32,90,91,93,97,25,27,37,92,93,94,100,26,28,30,39,71,72,75,93,29,45,72,73,76,94,34,38,52,66,92,96,99,103,35,39,53,95,97,100,104,36,40,48,54,93,96,98,101,105,37,41,74,75,77,97,38,42,49,55,67,68,71,78,98,43,46,59,94,99,101,102,106,44,47,50,68,69,72,80,86,101,57,86,89,90,100,103,105,106,107,58,77,79,82,104,59,60,62,75,78,80,83,91,105,61,63,76,80,81,84,87,93,106,71,73,79,83,84,85,92,97,107],C[[1,9,29,57,65,77,85,89,93,1,9,29,57,65,77,85,89,93,1,9,29,57,65,85,89,93,77,1,9,29,65,85,89,93,77,1,9,57,85,89,93,77,1,9,29,57,65,77,85,89,93,1,9,29,57,85,89,93,77,1,9,29,57,65,77,85,89,93,1,9,85,89,93,77,1,9,85,89,93,77,1,9,29,85,89,93,77,1,9,57,65,77,85,89,93,1,9,85,89,93,77,1,9,29,57,85,89,93,65,77,1,9,57,85,89,93,65,77,1,9,29,57,65,77,85,89,93,1,9,57,85,89,93,29,65,77,1,57,85,89,93,9,29,65,77,1,57,85,89,93,9,29,65,77,22,42,50,78,86,90,94,22,42,50,62,78,86,90,94,22,42,50,62,78,86,90,94,22,42,50,86,90,94,78,22,42,50,78,86,90,94,22,42,50,62,86,90,94,78,22,42,86,90,94,78,22,42,50,62,78,86,90,94,22,42,86,90,94,78,22,42,50,78,86,90,94,22,42,50,86,90,94,78,22,42,50,78,62,82,86,90,94,22,42,50,62,78,82,86,90,94,22,42,86,90,94,78,22,42,50,62,86,90,82,94,78,22,42,50,62,78,82,86,90,94,22,42,86,90,94,78,22,42,50,62,86,90,82,94,78,22,50,62,86,90,82,94,42,78,22,42,50,62,78,82,86,90,94,50,62,82,86,90,94,22,42,78,50,62,82,86,90,94,22,42,78,50,62,82,86,90,94,22,42,78,7,15,35,55,71,79,87,91,95,7,15,35,55,71,79,87,91,95,7,15,35,55,71,79,87,91,95,7,15,35,55,71,79,87,91,95,7,15,35,55,71,79,87,91,95,7,15,35,55,79,87,91,95,7,15,35,55,87,91,95,79,7,15,55,87,91,95,79,7,15,35,87,91,95,79,7,15,35,55,79,87,91,95,7,87,91,95,79,7,15,35,55,71,79,87,91,95,7,15,87,91,95,79,7,15,35,87,91,71,95,55,79,7,15,35,87,91,71,95,55,79,7,15,35,55,71,79,87,91,95,7,87,91,95,79,7,15,35,71,87,91,95,55,79,7,15,35,71,87,91,95,55,79,15,35,71,87,91,95,7,55,79,20,28,40,48,76,80,88,92,96,20,28,40,48,76,80,88,92,96,20,28,40,48,76,80,88,92,96,20,28,40,48,76,80,88,92,96,20,28,48,80,88,92,96,20,28,48,88,92,96,80,20,28,40,48,76,80,88,92,96,20,28,48,80,88,92,96,20,28,48,80,88,92,96,20,28,40,48,88,92,96,80,20,48,88,92,96,80,20,28,48,80,76,88,92,96,20,28,48,80,88,92,96,20,28,40,48,76,80,88,92,96,20,28,88,92,96,80,20,28,40,48,88,92,76,96,80,20,28,48,76,80,88,92,96,20,28,40,88,92,76,96,48,80,20,28,40,48,76,80,88,92,96,20,88,92,96,80,20,28,40,76,88,92,96,48,80,28,40,76,88,92,96,20,48,80,28,40,76,88,92,96,20,48,80]],85,107)
    M = Matrix(M)

    L,_,p = lu(M[:,1:70])
    Id = Matrix{Float64}(I,85,85)
    M = [L Id[:,71:end]][invperm(p),:]\M[:,71:end]
    M = M[end-14:end,:]

    T0 = zeros(22,22)
    T0[[1,3,4,6,8,9,12,13,15,16,17,19,20,21,22],:] = -M[:,16:end]
    T0[[178,247,315,406,429,454,480]] .= 1
    T1 = zeros(22,22)
    T1[[1,3,4,6,8,9,12,13,15,16,17,19,20,21,22],[1,3,4,6,8,9,12,13,15,16,17,19,20,21,22]] = M[:,1:15]
    T1[[24,93,139,208,231,300,392]] .= 1

    _,V = eigen(T0,T1)
    S = V[18:21,:]./repeat(V[22:22,:],4)
    S = S[:,vec(all(c -> !isinf(c) && !isnan(c), S; dims=1))]

    return S

end