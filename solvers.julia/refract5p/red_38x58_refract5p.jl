# Input: coefficient matrix C of size 3x29
# Output: solution matrix S of size 3x20

function red_38x58_refract5p(C::Array{Float64})

    M = sparse([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,29,29,29,29,29,29,29,29,29,30,30,30,30,30,30,30,30,30,31,31,31,31,31,31,31,31,31,32,32,32,32,32,32,32,32,32,33,33,33,33,33,33,33,33,33,34,34,34,34,34,34,34,34,34,35,35,35,35,35,35,35,35,35,36,36,36,36,36,36,36,36,36,37,37,37,37,37,37,37,37,37,38,38,38,38,38,38,38,38,38],[1,2,3,4,5,6,7,8,9,10,11,18,19,20,21,25,27,28,29,32,34,39,40,41,42,44,48,55,11,12,13,18,19,20,21,25,27,28,29,30,31,32,34,35,37,43,44,45,46,47,49,50,55,56,57,58,7,8,9,10,11,12,14,15,16,17,18,20,21,22,23,24,25,26,27,28,29,30,34,36,44,48,52,55,18,19,20,21,22,23,24,25,26,30,31,32,33,34,36,37,38,47,48,49,50,51,52,53,54,56,57,58,19,21,25,30,32,34,48,55,32,33,34,35,37,55,57,58,23,25,26,32,34,36,52,55,12,21,28,29,30,32,44,48,9,12,19,20,27,44,48,55,8,11,12,18,19,21,25,28,34,35,36,37,38,52,54,58,30,31,32,33,35,48,50,57,20,48,49,50,55,56,57,58,16,19,20,23,24,48,52,55,15,18,19,21,22,23,25,26,5,6,28,29,30,40,42,44,3,12,27,40,41,42,44,48,2,4,5,11,12,21,28,40,24,52,53,54,55,56,57,58,13,29,30,31,33,44,46,50,27,44,45,46,48,49,50,57,18,20,21,25,30,32,34,48,55,25,32,33,34,35,37,56,57,58,22,24,25,26,32,34,36,52,55,11,21,27,28,29,30,32,44,48,8,10,12,19,20,27,44,48,55,7,9,11,12,18,19,21,25,28,26,34,35,36,37,38,53,54,58,21,30,31,32,33,35,49,50,57,19,47,48,49,50,55,56,57,58,15,17,19,20,23,24,48,52,55,14,16,18,19,21,22,23,25,26,4,5,6,28,29,30,41,42,44,2,12,27,39,40,41,42,44,48,1,3,4,5,11,12,21,28,40,23,51,52,53,54,55,56,57,58,13,28,29,30,31,33,45,46,50,12,43,44,45,46,48,49,50,57],C[[1,4,7,13,22,28,31,34,37,40,43,58,61,64,67,76,46,49,55,82,85,10,16,19,25,52,70,79,1,4,28,31,34,37,43,58,7,13,22,49,55,67,76,82,85,10,16,19,25,40,46,52,61,64,70,79,1,4,7,10,13,16,31,34,37,40,43,46,49,58,61,64,67,76,19,22,28,55,82,85,25,52,79,70,1,4,7,13,31,34,37,43,58,22,28,49,55,67,76,82,85,10,16,19,25,40,61,64,79,46,52,70,62,68,77,74,83,86,71,80,68,74,77,83,86,62,71,80,62,68,77,74,83,86,80,71,62,77,68,74,83,86,71,80,62,68,77,80,71,74,83,86,62,68,71,77,80,83,86,74,68,74,77,83,86,62,80,71,68,74,77,83,86,62,71,80,62,68,71,74,77,80,83,86,62,68,71,77,80,74,86,83,62,68,71,74,77,80,83,86,68,74,77,83,86,62,71,80,62,77,80,68,71,74,83,86,62,68,74,77,80,86,83,71,62,77,80,86,68,71,74,83,74,68,77,83,86,62,71,80,62,68,71,74,77,80,83,86,60,66,69,78,75,84,87,72,81,60,69,75,78,84,87,66,72,81,60,66,69,78,75,84,87,81,72,60,78,66,69,75,84,87,72,81,60,66,69,78,81,72,75,84,87,60,66,69,72,78,81,84,87,75,60,69,75,78,84,87,66,81,72,60,69,75,78,84,87,66,72,81,60,66,69,72,75,78,81,84,87,60,66,69,72,78,81,75,87,84,60,66,69,72,75,78,81,84,87,60,69,75,78,84,87,66,72,81,60,78,81,66,69,72,75,84,87,60,66,69,75,78,81,87,84,72,60,66,78,81,87,69,72,75,84,75,60,69,78,84,87,66,72,81,60,66,69,72,75,78,81,84,87]],38,58)
    M = Matrix(M)

    L,_,p = lu(M[:,1:26])
    Id = Matrix{Float64}(I,38,38)
    M = [L Id[:,27:end]][invperm(p),:]\M[:,27:end]
    M = M[end-11:end,:]

    T0 = zeros(20,20)
    T0[[1,2,4,6,8,10,12,17,19,14,20,16],:] = -M[:,13:end]
    T0[[103,205,227,349,371,293,315,398]] .= 1
    T1 = zeros(20,20)
    T1[[1,2,4,6,8,10,12,17,19,14,20,16],[1,2,4,6,8,10,12,17,19,14,20,16]] = M[:,1:12]
    T1[[43,85,127,169,211,253,295,358]] .= 1

    _,V = eigen(T0,T1)
    S = V[17:19,:]./repeat(V[20:20,:],3)
    S = S[:,vec(all(c -> !isinf(c) && !isnan(c), S; dims=1))]

    return S

end